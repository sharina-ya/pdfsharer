<!DOCTYPE html>
<html>
<head>
    <title>{{ board.title }}</title>
    <style>
        body {
            margin: 0;
            padding: 0;
            overflow: hidden;
            font-family: Arial, sans-serif;
        }
        #pdf-container {
            position: fixed;
            top: 0;
            left: 0;
            width: 100vw;
            height: 100vh;
            display: flex;
            justify-content: center;
            align-items: center;
            background-color: #f0f0f0;
        }
        #pdf-render {
            max-width: 100%;
            max-height: 100%;
            box-shadow: 0 0 10px rgba(0,0,0,0.5);
        }
        #drawing-canvas {
            position: absolute;
            top: 0;
            left: 0;
            z-index: 10;
            width: 100%;
            height: 100%;
            cursor: crosshair;
        }
        .toolbar {
            position: fixed;
            top: 10px;
            left: 10px;
            z-index: 100;
            background: white;
            padding: 10px;
            border-radius: 5px;
            box-shadow: 0 0 5px rgba(0,0,0,0.3);
            display: flex;
            gap: 10px;
            align-items: center;
        }
        .toolbar button {
            padding: 5px 10px;
            cursor: pointer;
        }
    </style>
</head>
<body>
    <div class="toolbar">
        <button id="clear-btn">Очистить</button>
        <input type="color" id="color-picker" value="#000000">
        <input type="range" id="brush-size" min="1" max="20" value="3">
        <button id="save-btn">Сохранить</button>
    </div>

    <div id="pdf-container">
        <canvas id="pdf-render"></canvas>
        <canvas id="drawing-canvas"></canvas>
    </div>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/2.11.338/pdf.min.js"></script>
    <script>

        const pdfContainer = document.getElementById('pdf-container');
        const pdfCanvas = document.getElementById('pdf-render');
        const drawingCanvas = document.getElementById('drawing-canvas');
        const ctx = drawingCanvas.getContext('2d');
        let isDrawing = false;
        let currentColor = '#000000';
        let brushSize = 3;


        function resizeCanvases() {
            const width = window.innerWidth;
            const height = window.innerHeight;

            pdfCanvas.width = width;
            pdfCanvas.height = height;
            drawingCanvas.width = width;
            drawingCanvas.height = height;
        }

        window.addEventListener('resize', resizeCanvases);
        resizeCanvases();

        pdfjsLib.GlobalWorkerOptions.workerSrc = 'https://cdnjs.cloudflare.com/ajax/libs/pdf.js/2.11.338/pdf.worker.min.js';

        const url = "{{ board.pdf_file.url }}";
        let pdfDocument = null; // Сохраняем объект PDF документа

        pdfjsLib.getDocument(url).promise.then(function(pdf) {
            pdfDocument = pdf;
            pdf.getPage(1).then(function(page) {
                const viewport = page.getViewport({ scale: 1.5 });

                const canvasContext = pdfCanvas.getContext('2d');
                pdfCanvas.width = viewport.width;
                pdfCanvas.height = viewport.height;

                page.render({
                    canvasContext: canvasContext,
                    viewport: viewport
                });
            });
        });


        drawingCanvas.addEventListener('mousedown', startDrawing);
        drawingCanvas.addEventListener('mousemove', draw);
        drawingCanvas.addEventListener('mouseup', stopDrawing);
        drawingCanvas.addEventListener('mouseout', stopDrawing);

        function startDrawing(e) {
            isDrawing = true;
            ctx.beginPath();
            ctx.moveTo(e.clientX, e.clientY);
        }

        function draw(e) {
            if (!isDrawing) return;

            ctx.lineTo(e.clientX, e.clientY);
            ctx.strokeStyle = currentColor;
            ctx.lineWidth = brushSize;
            ctx.lineCap = 'round';
            ctx.stroke();
            ctx.beginPath();
            ctx.moveTo(e.clientX, e.clientY);
        }

        function stopDrawing() {
            isDrawing = false;
            ctx.beginPath();
        }

        // Очистка
        document.getElementById('clear-btn').addEventListener('click', function() {
            ctx.clearRect(0, 0, drawingCanvas.width, drawingCanvas.height);
        });

        // Изменение цвета и размера кисти
        document.getElementById('color-picker').addEventListener('input', function(e) {
            currentColor = e.target.value;
        });

        document.getElementById('brush-size').addEventListener('input', function(e) {
            brushSize = e.target.value;
        });


        document.getElementById('save-btn').addEventListener('click', function() {
            const combinedCanvas = document.createElement('canvas');
            combinedCanvas.width = pdfCanvas.width;
            combinedCanvas.height = pdfCanvas.height;
            const combinedCtx = combinedCanvas.getContext('2d');

            combinedCtx.drawImage(pdfCanvas, 0, 0);
            combinedCtx.drawImage(drawingCanvas, 0, 0);


            const link = document.createElement('a');
            link.href = combinedCanvas.toDataURL('application/pdf');
   
            link.click();
        // Сохраняем рисунок в localStorage
            localStorage.setItem('savedDrawing', drawingCanvas.toDataURL());
        });


        document.getElementById('clear-btn').addEventListener('click', function() {
            ctx.clearRect(0, 0, drawingCanvas.width, drawingCanvas.height);
            localStorage.removeItem('savedDrawing'); // Очищаем localStorage
        });

        document.getElementById('color-picker').addEventListener('change', function(e) {
            currentColor = e.target.value;
        });


        document.getElementById('brush-size').addEventListener('input', function(e) {
            brushSize = e.target.value;
        });

        function loadSavedDrawing() {
            const savedDrawing = localStorage.getItem('savedDrawing');
            if (savedDrawing) {
                const img = new Image();
                img.onload = function() {
                    ctx.drawImage(img, 0, 0);
                };
                img.src = savedDrawing;
            }
        }
    </script>
</body>
</html>
